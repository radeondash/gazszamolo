<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Gáz keret kalkulátor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            background: #111;
            color: #eee;
        }
        .app {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px 10px 18px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 8px;
        }
        .title {
            font-size: 0.98rem;
            font-weight: 600;
            color: #ffcc33;
            text-align: center;
            flex: 1;
        }
        .topbtn {
            font-size: 0.78rem;
            padding: 4px 8px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #222;
            color: #ffd966;
            white-space: nowrap;
        }
        .topbtn:active {
            transform: scale(0.97);
        }
        .card {
            background: #1b1b1b;
            border-radius: 10px;
            padding: 9px 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.35);
        }
        label {
            display: block;
            font-size: 0.82rem;
            margin-bottom: 3px;
        }
        input[type="number"],
        input[type="date"] {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 7px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #111;
            color: #eee;
            font-size: 0.9rem;
        }
        input[type="number"]::placeholder {
            color: #666;
        }
        button.main {
            margin-top: 8px;
            padding: 7px 12px;
            border-radius: 999px;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            background: #ffcc33;
            color: #000;
            width: 100%;
        }
        button.main:active {
            transform: scale(0.97);
        }
        .small {
            font-size: 0.75rem;
            color: #aaa;
        }
        .results {
            font-size: 0.86rem;
            line-height: 1.35;
            margin-top: 8px;
        }
        .mono {
            font-family: "SF Mono", "Consolas", monospace;
        }
        #monthInfo {
            margin-top: 6px;
            font-size: 0.78rem;
            color: #9ad0ff;
        }

        /* Előzmények nézet */
        #historyView {
            display: none;
        }
        .history-header {
            font-size: 0.85rem;
            color: #ccc;
            margin-bottom: 4px;
        }
        .history-list {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: calc(100vh - 90px);
            overflow-y: auto;
            padding-right: 2px;
        }
        .history-item {
            background: #1b1b1b;
            border-radius: 8px;
            padding: 7px 9px;
            font-size: 0.8rem;
            border-left: 3px solid #444;
        }
        .history-item.monthly {
            border-left-color: #ffd966;
        }
        .history-item.daily {
            border-left-color: #66c2ff;
        }
        .history-line1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
            margin-bottom: 3px;
        }
        .history-date {
            font-weight: 600;
            font-size: 0.82rem;
        }
        .history-tag {
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 999px;
            background: #222;
        }
        .tag-monthly {
            color: #ffd966;
        }
        .tag-daily {
            color: #66c2ff;
        }
        .history-metric {
            margin-top: 2px;
        }
        .muted {
            color: #999;
        }
        .hist-strong {
            font-weight: 600;
        }

        @media (max-width: 400px) {
            .app {
                padding: 8px 8px 16px;
            }
            .title {
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
<div class="app">

    <!-- FŐ NÉZET -->
    <div id="mainView">
        <div class="topbar">
            <button class="topbtn" type="button" onclick="openMonthlyDict()">Havi diktálás</button>
            <div class="title">Gáz keret (6–6)</div>
            <button class="topbtn" type="button" onclick="openHistoryView()">Előzmények</button>
        </div>

        <div class="card">
            <label for="readingDate">Dátum</label>
            <input type="date" id="readingDate">

            <label for="currentReading" style="margin-top:6px;">Mai mérőállás (m³)</label>
            <input type="number" id="currentReading" inputmode="decimal" placeholder="pl. 2258">

            <button class="main" type="button" onclick="calculate()">Számolás</button>

            <div id="monthInfo"></div>
            <div id="calcResult" class="results"></div>

            <div class="small" style="margin-top:6px;">
                A „hónap” itt mindig <b>6-tól 6-ig</b> tart (pl. nov. 6 – dec. 6).
                Az órák/nap számításhoz egy átlagos m³/óra értéket használunk.
            </div>
        </div>
    </div>

    <!-- ELŐZMÉNYEK NÉZET -->
    <div id="historyView">
        <div class="topbar">
            <button class="topbtn" type="button" onclick="openMainView()">← Vissza</button>
            <div class="title">Előzmények</div>
            <div style="width:65px;"></div>
        </div>

        <div class="card">
            <div class="history-header">
                A legutóbbi <span class="hist-strong">Havi</span> diktálások és
                <span class="hist-strong">Napi</span> számolások.
            </div>
            <div id="historyList" class="history-list"></div>
            <div id="historyEmpty" class="small" style="display:none;margin-top:4px;">
                Még nincs elmentett előzmény. A <b>Számolás</b> és a <b>Havi diktálás</b> gombok
                minden futása bekerül ide.
            </div>
        </div>
    </div>

</div>

<script>
    const HOURLY_USAGE = 3.2;

    const monthlyQuota = {
        1: 329,
        2: 270,
        3: 223,
        4: 116,
        5: 36,
        6: 15,
        7: 16,
        8: 16,
        9: 37,
        10: 143,
        11: 216,
        12: 306
    };

    const monthNamesHu = [
        "január", "február", "március", "április",
        "május", "június", "július", "augusztus",
        "szeptember", "október", "november", "december"
    ];

    const CFG_PREFIX = "gmCfg-";
    const HIST_KEY   = "gmHistory";

    // KÖZÖS ÁLLAPOT – EZ KERÜL A gaz_data.json FÁJLBA
    let gasState = {
        cfg: {},      // { "gmCfg-2025-11": { startReading: 2280, quota: 216 }, ... }
        history: []   // [ {type:"daily"/"monthly", ...}, ... ]
    };

    // ====== SZERVER KOMMUNIKÁCIÓ (PHP) ===================================

    async function loadAllData() {
        try {
            const resp = await fetch('gaz_api.php?action=load', { cache: 'no-store' });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();
            gasState = {
                cfg: data.cfg || {},
                history: Array.isArray(data.history) ? data.history : []
            };
        } catch (e) {
            console.error('Adatbetöltés hiba:', e);
            gasState = { cfg: {}, history: [] };
        }
    }

    async function saveAllData() {
        try {
            await fetch('gaz_api.php?action=save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gasState)
            });
        } catch (e) {
            console.error('Adatmentés hiba:', e);
        }
    }

    // ====== HELYI SEGÉDFÜGGVÉNYEK (state felett) =========================

    function getCfgKey(year, monthIndex0) {
        const m = String(monthIndex0 + 1).padStart(2, "0");
        return CFG_PREFIX + year + "-" + m;
    }

    function todayISO() {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, "0");
        const dd = String(t.getDate()).padStart(2, "0");
        return yyyy + "-" + mm + "-" + dd;
    }

    function toISODateLocal(dateObj) {
        const yyyy = dateObj.getFullYear();
        const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
        const dd = String(dateObj.getDate()).padStart(2, "0");
        return yyyy + "-" + mm + "-" + dd;
    }

    function getGasPeriod(dateObj) {
        const d = dateObj.getDate();
        let startYear = dateObj.getFullYear();
        let startMonth = dateObj.getMonth();

        if (d < 6) {
            startMonth -= 1;
            if (startMonth < 0) {
                startMonth = 11;
                startYear -= 1;
            }
        }
        const gasStart = new Date(startYear, startMonth, 6);

        let endYear = startYear;
        let endMonth = startMonth + 1;
        if (endMonth > 11) {
            endMonth = 0;
            endYear += 1;
        }
        const gasEnd = new Date(endYear, endMonth, 6);

        const totalDays = Math.round((gasEnd - gasStart) / 86400000);
        const diffDays = Math.floor((dateObj - gasStart) / 86400000);
        const daysElapsed = diffDays + 1;

        return {
            gasStart,
            gasEnd,
            startYear,
            startMonth,
            endYear,
            endMonth,
            totalDays,
            daysElapsed
        };
    }

    function loadMonthConfig(year, monthIndex0) {
        const key = getCfgKey(year, monthIndex0);
        return gasState.cfg[key] || null;
    }

    function saveMonthConfig(year, monthIndex0, startReading) {
        const key = getCfgKey(year, monthIndex0);
        const quota = monthlyQuota[monthIndex0 + 1] || 0;
        gasState.cfg[key] = { startReading, quota };
        saveAllData();
    }

    function getHistory() {
        return gasState.history || [];
    }

    function saveHistory(arr) {
        gasState.history = arr;
        saveAllData();
    }

    function addHistory(entry) {
        if (!Array.isArray(gasState.history)) gasState.history = [];
        entry.ts = new Date().toISOString();
        gasState.history.push(entry);
        saveAllData();
    }

    function formatGasPeriodLabel(period) {
        const startLabel = period.startYear + ". " +
            monthNamesHu[period.startMonth] + " 6.";
        const endLabel = period.endYear + ". " +
            monthNamesHu[period.endMonth] + " 6.";
        return startLabel + " – " + endLabel;
    }

    function updateMonthInfo(dateObj) {
        const infoDiv = document.getElementById("monthInfo");
        const period = getGasPeriod(dateObj);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const cfg = loadMonthConfig(period.startYear, period.startMonth);
        const gasLabel = formatGasPeriodLabel(period);

        let text = "";
        if (cfg && cfg.startReading != null) {
            text = "Gáz-hónap: " + gasLabel +
                " · Keret: " + quota + " m³, induló állás: " +
                cfg.startReading + " m³ (" +
                period.startYear + ". " +
                monthNamesHu[period.startMonth] + ")";
        } else {
            text = "Gáz-hónap: " + gasLabel +
                " · Keret: " + quota +
                " m³. Induló állás még nincs beállítva (" +
                period.startYear + ". " +
                monthNamesHu[period.startMonth] + ").";
        }

        const day = dateObj.getDate();
        if (day < 6) {
            const daysLeft = 6 - day;
            text += " · Leolvasásig még " + daysLeft + " nap.";
        } else if (day === 6) {
            text += " · Ma van a leolvasás napja.";
        }

        infoDiv.textContent = text;
    }

    function suggestNextSixth() {
        const today = new Date();
        let candidate = new Date(today.getFullYear(), today.getMonth(), 6);
        if (today.getDate() > 6) {
            candidate.setMonth(candidate.getMonth() + 1);
        }
        candidate.setDate(6);

        for (let i = 0; i < 24; i++) {
            const key = getCfgKey(candidate.getFullYear(), candidate.getMonth());
            if (!gasState.cfg[key]) break;
            candidate = new Date(candidate.getFullYear(), candidate.getMonth() + 1, 6);
        }
        return candidate;
    }

    function openHistoryView() {
        renderHistory();
        document.getElementById("mainView").style.display = "none";
        document.getElementById("historyView").style.display = "block";
    }

    function openMainView() {
        document.getElementById("historyView").style.display = "none";
        document.getElementById("mainView").style.display = "block";
    }

    function openMonthlyDict() {
        const suggestion = suggestNextSixth();
        const defStr = toISODateLocal(suggestion);

        const input = prompt(
            "Válassz egy 6-ai leolvasási dátumot (ÉÉÉÉ-HH-06):",
            defStr
        );
        if (input === null || input.trim() === "") return;

        const trimmed = input.trim();
        const dt = new Date(trimmed);
        if (isNaN(dt.getTime())) {
            alert("Érvénytelen dátum. Használd pl. ezt a formátumot: 2025-12-06");
            return;
        }
        if (dt.getDate() !== 6) {
            alert("A dátum napja legyen 6.");
            return;
        }

        const period = getGasPeriod(dt);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const gasLabel = formatGasPeriodLabel(period);

        let readingStr = document.getElementById("currentReading").value;
        let startVal;

        if (readingStr && readingStr.trim() !== "") {
            startVal = parseFloat(readingStr.replace(",", "."));
            if (isNaN(startVal)) {
                alert("Érvénytelen szám a mérőállás mezőben.");
                return;
            }
        } else {
            const ask = prompt(
                "Gáz-hónap: " + gasLabel + "\n" +
                "(" + period.startYear + ". " + monthNamesHu[period.startMonth] +
                ", keret: " + quota + " m³)\n\n" +
                "Írd be a leolvasott mérőállást (m³):"
            );
            if (ask === null || ask.trim() === "") return;
            startVal = parseFloat(ask.replace(",", "."));
            if (isNaN(startVal)) {
                alert("Érvénytelen szám.");
                return;
            }
        }

        saveMonthConfig(period.startYear, period.startMonth, startVal);
        addHistory({
            type: "monthly",
            date: toISODateLocal(dt),
            reading: startVal,
            periodStartYear: period.startYear,
            periodStartMonth: period.startMonth,
            quota: quota,
            gasLabel: gasLabel
        });

        document.getElementById("readingDate").value = toISODateLocal(dt);
        updateMonthInfo(dt);

        alert(
            "Havi induló állás rögzítve: " + startVal + " m³\n" +
            "Gáz-hónap: " + gasLabel
        );
    }

    function calculate() {
        const dateStr = document.getElementById("readingDate").value;
        const readingStr = document.getElementById("currentReading").value;
        const resultDiv = document.getElementById("calcResult");

        if (!dateStr || !readingStr) {
            alert("Add meg a dátumot és a mai mérőállást.");
            return;
        }

        const dt = new Date(dateStr);
        if (isNaN(dt.getTime())) {
            alert("Érvénytelen dátum.");
            return;
        }

        const period = getGasPeriod(dt);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const daysInGasMonth = period.totalDays;
        const daysElapsed = period.daysElapsed;
        const gasLabel = formatGasPeriodLabel(period);

        let cfg = loadMonthConfig(period.startYear, period.startMonth);
        let startReading = cfg && cfg.startReading != null ? cfg.startReading : null;

        if (startReading == null || isNaN(startReading)) {
            const ask = prompt(
                "Nincs beállítva induló mérőállás ehhez a gáz-hónaphoz:\n" +
                gasLabel + "\n" +
                "(" + period.startYear + ". " +
                monthNamesHu[period.startMonth] + ", keret: " +
                quota + " m³)\n\nAdd meg most (m³):"
            );
            if (ask === null || ask.trim() === "") {
                resultDiv.textContent = "Nincs induló mérőállás, megszakítva.";
                return;
            }
            startReading = parseFloat(ask.replace(",", "."));
            if (isNaN(startReading)) {
                alert("Érvénytelen szám.");
                return;
            }
            saveMonthConfig(period.startYear, period.startMonth, startReading);
            cfg = loadMonthConfig(period.startYear, period.startMonth);
            updateMonthInfo(dt);
        }

        let currentReading = parseFloat(readingStr.replace(",", "."));
        if (isNaN(currentReading)) {
            alert("Érvénytelen szám a mai mérőállásnál.");
            return;
        }

        if (currentReading < startReading) {
            alert("A mai mérőállás nem lehet kisebb, mint a gáz-hónap induló mérőállása.");
            return;
        }

        const consumedSoFar = currentReading - startReading;
        const dailyQuota = quota / daysInGasMonth;
        const allowedSoFar = dailyQuota * daysElapsed;
        const remaining = quota - consumedSoFar;
        const daysLeft = daysInGasMonth - daysElapsed;

        const avgHoursFullMonth = dailyQuota / HOURLY_USAGE;
        let avgHoursRemaining = 0;
        if (daysLeft > 0 && remaining > 0) {
            avgHoursRemaining = (remaining / daysLeft) / HOURLY_USAGE;
        }

        const idealMeterToday = startReading + allowedSoFar;

        const consumedStr = consumedSoFar.toFixed(1).replace(".", ",");
        const remainingStr = remaining.toFixed(1).replace(".", ",");
        const avgHoursRemStr = avgHoursRemaining.toFixed(2).replace(".", ",");

        const remLabel = remaining > 0
            ? remainingStr + " m³"
            : remainingStr + " m³ (túllépés)";

        const hrsLabel = avgHoursRemaining > 0
            ? avgHoursRemStr + " óra/nap"
            : "0 óra/nap";

        resultDiv.innerHTML =
            "<div class='mono'>Dátum: " + dateStr +
            " · " + gasLabel + "</div>" +
            "<div style='margin-top:4px;'>Mérőállás: <span class='mono'>" +
            currentReading + " m³</span> · Fogyasztás eddig: <span class='mono'>" +
            consumedStr + " m³</span></div>" +
            "<div style='margin-top:2px;'>Maradék keret: <span class='mono'>" +
            remLabel + "</span> · Innentől kb.: <span class='mono'>" +
            hrsLabel + "</span></div>";

        addHistory({
            type: "daily",
            date: dateStr,
            reading: currentReading,
            periodStartYear: period.startYear,
            periodStartMonth: period.startMonth,
            quota: quota,
            gasLabel: gasLabel,
            consumed: consumedSoFar,
            remaining: remaining,
            daysElapsed: daysElapsed,
            daysTotal: daysInGasMonth,
            idealMeter: idealMeterToday,
            diff: consumedSoFar - allowedSoFar,
            avgHoursFullMonth: avgHoursFullMonth,
            avgHoursRemaining: avgHoursRemaining
        });
    }

    function renderHistory() {
        const hist = getHistory();
        const listEl = document.getElementById("historyList");
        const emptyEl = document.getElementById("historyEmpty");

        listEl.innerHTML = "";

        if (!hist.length) {
            emptyEl.style.display = "block";
            return;
        }
        emptyEl.style.display = "none";

        hist.sort((a, b) => (b.ts || "").localeCompare(a.ts || ""));

        hist.forEach(entry => {
            const item = document.createElement("div");
            item.classList.add("history-item");
            if (entry.type === "monthly") item.classList.add("monthly");
            if (entry.type === "daily") item.classList.add("daily");

            const line1 = document.createElement("div");
            line1.className = "history-line1";

            const dateSpan = document.createElement("div");
            dateSpan.className = "history-date";
            dateSpan.textContent = entry.date || (entry.ts ? entry.ts.slice(0,10) : "");
            line1.appendChild(dateSpan);

            const tag = document.createElement("span");
            tag.classList.add("history-tag");
            if (entry.type === "monthly") {
                tag.classList.add("tag-monthly");
                tag.textContent = "Havi";
            } else if (entry.type === "daily") {
                tag.classList.add("tag-daily");
                tag.textContent = "Napi";
            } else {
                tag.textContent = "Egyéb";
            }
            line1.appendChild(tag);

            item.appendChild(line1);

            const gasLabel = entry.gasLabel || "";

            const line2 = document.createElement("div");
            line2.className = "history-metric muted";
            line2.textContent = gasLabel;
            item.appendChild(line2);

            if (entry.type === "monthly") {
                const r = (entry.reading != null ? entry.reading : "?");
                const q = (entry.quota != null ? entry.quota : "?");
                const line3 = document.createElement("div");
                line3.className = "history-metric";
                line3.innerHTML =
                    "Induló mérőállás: <span class='hist-strong mono'>" + r +
                    " m³</span> · Keret: " + q + " m³";
                item.appendChild(line3);
            } else if (entry.type === "daily") {
                const r = (entry.reading != null ? entry.reading : "?");
                const c = (typeof entry.consumed === "number")
                    ? entry.consumed.toFixed(1).replace(".", ",")
                    : "?";
                const rem = (typeof entry.remaining === "number")
                    ? entry.remaining.toFixed(1).replace(".", ",")
                    : "?";
                const hrs = (typeof entry.avgHoursRemaining === "number")
                    ? entry.avgHoursRemaining.toFixed(2).replace(".", ",")
                    : "?";

                const line3 = document.createElement("div");
                line3.className = "history-metric";
                line3.innerHTML =
                    "Mérőállás: <span class='mono'>" + r +
                    " m³</span> · Fogyasztás eddig: <span class='mono'>" + c + " m³</span>";
                item.appendChild(line3);

                const line4 = document.createElement("div");
                line4.className = "history-metric";
                line4.innerHTML =
                    "Maradék keret: <span class='mono'>" + rem +
                    " m³</span> · Innentől kb.: <span class='mono'>" + hrs +
                    " óra/nap</span>";
                item.appendChild(line4);
            } else {
                const raw = document.createElement("div");
                raw.className = "history-metric muted";
                raw.textContent = JSON.stringify(entry);
                item.appendChild(raw);
            }

            listEl.appendChild(item);
        });
    }

    async function boot() {
        await loadAllData();

        // Beégetett induló állás 2025. november 6-ra, ha még nincs semmi config
        const initialYear = 2025;
        const initialMonthIndex = 10; // november
        const initialKey = getCfgKey(initialYear, initialMonthIndex);
        if (!gasState.cfg[initialKey]) {
            gasState.cfg[initialKey] = {
                startReading: 2280,
                quota: monthlyQuota[11] || 216
            };
            saveAllData();
        }

        const rd = document.getElementById("readingDate");
        rd.value = todayISO();
        const d = new Date(rd.value);
        updateMonthInfo(d);

        rd.addEventListener("change", function () {
            const dt = new Date(this.value);
            if (!isNaN(dt.getTime())) {
                updateMonthInfo(dt);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
