<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Gáz keret kalkulátor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            background: #111;
            color: #eee;
        }
        .app {
            max-width: 600px;
            margin: 0 auto;
            padding: 12px 14px 20px;
        }
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 6px;
        }
        .title {
            font-size: 1.0rem;
            font-weight: 600;
            color: #ffcc33;
            text-align: center;
            flex: 1;
        }
        .topbtn {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #222;
            color: #ffd966;
            white-space: nowrap;
        }
        .topbtn:hover {
            filter: brightness(1.1);
        }
        .card {
            background: #1b1b1b;
            border-radius: 10px;
            padding: 10px 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        input[type="number"],
        input[type="date"] {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #111;
            color: #eee;
            font-size: 0.95rem;
        }
        input[type="number"]::placeholder {
            color: #666;
        }
        button.main {
            margin-top: 8px;
            padding: 7px 12px;
            border-radius: 999px;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: #ffcc33;
            color: #000;
            width: 100%;
        }
        button.main:hover {
            filter: brightness(1.05);
        }
        .small {
            font-size: 0.78rem;
            color: #aaa;
        }
        .results {
            font-size: 0.88rem;
            line-height: 1.4;
            margin-top: 8px;
        }
        .good {
            color: #86d993;
        }
        .bad {
            color: #ff8c8c;
        }
        .neutral {
            color: #ffd966;
        }
        .mono {
            font-family: "SF Mono", "Consolas", monospace;
        }
        #monthInfo {
            margin-top: 6px;
            font-size: 0.78rem;
            color: #9ad0ff;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <button class="topbtn" type="button" onclick="openMonthlyDict()">Havi diktálás</button>
        <div class="title">Gáz keret (6–6)</div>
        <button class="topbtn" type="button" onclick="showHistory()">Előzmények</button>
    </div>

    <div class="card">
        <label for="readingDate">Dátum</label>
        <input type="date" id="readingDate">

        <label for="currentReading" style="margin-top:6px;">Mai mérőállás (m³)</label>
        <input type="number" id="currentReading" inputmode="decimal" placeholder="pl. 2258">

        <button class="main" type="button" onclick="calculate()">Számolás</button>

        <div id="monthInfo"></div>
        <div id="calcResult" class="results"></div>

        <div class="small" style="margin-top:6px;">
            A „hónap” itt mindig <b>6-tól 6-ig</b> tart (pl. nov. 6 – dec. 6).
            Az órák/nap számításhoz egy átlagos m³/óra értéket használunk.
        </div>
    </div>
</div>

<script>
    // ===== Beállítások =====
    const HOURLY_USAGE = 3.2; // m³/óra – ha más, írd át

    // Havi kedvezményes keretek (m³) – annak a hónapnak, amelyben a gáz-hónap INDUL
    const monthlyQuota = {
        1: 329,
        2: 270,
        3: 223,
        4: 116,
        5: 36,
        6: 15,
        7: 16,
        8: 16,
        9: 37,
        10: 143,
        11: 216,
        12: 306
    };

    const monthNamesHu = [
        "január", "február", "március", "április",
        "május", "június", "július", "augusztus",
        "szeptember", "október", "november", "december"
    ];

    const CFG_PREFIX = "gmCfg-";    // gáz-hónap configok
    const HIST_KEY   = "gmHistory"; // előzmények

    function getCfgKey(year, monthIndex0) {
        const m = String(monthIndex0 + 1).padStart(2, "0");
        return CFG_PREFIX + year + "-" + m; // pl. gmCfg-2025-11
    }

    function todayISO() {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, "0");
        const dd = String(t.getDate()).padStart(2, "0");
        return yyyy + "-" + mm + "-" + dd;
    }

    function toISODateLocal(dateObj) {
        const yyyy = dateObj.getFullYear();
        const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
        const dd = String(dateObj.getDate()).padStart(2, "0");
        return yyyy + "-" + mm + "-" + dd;
    }

    // Gáz-hónap: mindig hónap 6-tól következő hónap 6-ig
    function getGasPeriod(dateObj) {
        const d = dateObj.getDate();
        let startYear = dateObj.getFullYear();
        let startMonth = dateObj.getMonth(); // 0-11

        if (d < 6) {
            startMonth -= 1;
            if (startMonth < 0) {
                startMonth = 11;
                startYear -= 1;
            }
        }
        const gasStart = new Date(startYear, startMonth, 6);

        let endYear = startYear;
        let endMonth = startMonth + 1;
        if (endMonth > 11) {
            endMonth = 0;
            endYear += 1;
        }
        const gasEnd = new Date(endYear, endMonth, 6); // kizárólagos

        const totalDays = Math.round((gasEnd - gasStart) / 86400000);
        const diffDays = Math.floor((dateObj - gasStart) / 86400000);
        const daysElapsed = diffDays + 1; // 6-a = 1. nap

        return {
            gasStart,
            gasEnd,
            startYear,
            startMonth,
            endYear,
            endMonth,
            totalDays,
            daysElapsed
        };
    }

    function loadMonthConfig(year, monthIndex0) {
        const key = getCfgKey(year, monthIndex0);
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        try {
            return JSON.parse(raw);
        } catch {
            return null;
        }
    }

    function saveMonthConfig(year, monthIndex0, startReading) {
        const key = getCfgKey(year, monthIndex0);
        const quota = monthlyQuota[monthIndex0 + 1] || 0;
        const cfg = {
            startReading: startReading,
            quota: quota
        };
        localStorage.setItem(key, JSON.stringify(cfg));
    }

    function formatGasPeriodLabel(period) {
        const startLabel = period.startYear + ". " +
            monthNamesHu[period.startMonth] + " 6.";
        const endLabel = period.endYear + ". " +
            monthNamesHu[period.endMonth] + " 6.";
        return startLabel + " – " + endLabel;
    }

    function getHistory() {
        const raw = localStorage.getItem(HIST_KEY);
        if (!raw) return [];
        try {
            const arr = JSON.parse(raw);
            return Array.isArray(arr) ? arr : [];
        } catch {
            return [];
        }
    }

    function saveHistory(arr) {
        localStorage.setItem(HIST_KEY, JSON.stringify(arr));
    }

    function addHistory(entry) {
        const arr = getHistory();
        entry.ts = new Date().toISOString();
        arr.push(entry);
        saveHistory(arr);
    }

    function updateMonthInfo(dateObj) {
        const infoDiv = document.getElementById("monthInfo");
        const period = getGasPeriod(dateObj);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const cfg = loadMonthConfig(period.startYear, period.startMonth);
        const gasLabel = formatGasPeriodLabel(period);

        let text = "";
        if (cfg && cfg.startReading != null) {
            text =
                "Gáz-hónap: " + gasLabel +
                " · Keret: " + quota + " m³, induló állás: " +
                cfg.startReading + " m³ (" +
                period.startYear + ". " +
                monthNamesHu[period.startMonth] + ")";
        } else {
            text =
                "Gáz-hónap: " + gasLabel +
                " · Keret: " + quota +
                " m³. Induló állás még nincs beállítva (" +
                period.startYear + ". " +
                monthNamesHu[period.startMonth] + ").";
        }

        const day = dateObj.getDate();
        if (day < 6) {
            const daysLeft = 6 - day;
            text += " · Leolvasásig még " + daysLeft + " nap.";
        } else if (day === 6) {
            text += " · Ma van a leolvasás napja.";
        }

        infoDiv.textContent = text;
    }

    function suggestNextSixth() {
        const today = new Date();
        let candidate = new Date(today.getFullYear(), today.getMonth(), 6);
        if (today.getDate() > 6) {
            candidate.setMonth(candidate.getMonth() + 1);
        }
        candidate.setDate(6);

        // keresd a következő 6-át, amihez még nincs config
        for (let i = 0; i < 24; i++) {
            const key = getCfgKey(candidate.getFullYear(), candidate.getMonth());
            if (!localStorage.getItem(key)) break;
            candidate = new Date(candidate.getFullYear(), candidate.getMonth() + 1, 6);
        }
        return candidate;
    }

    function init() {
        // Beégetett induló állás 2025. november 6-ra (gáz-hónap indul: 2025-11-06)
        const initialYear = 2025;
        const initialMonthIndex = 10; // november (0-alapú)
        const initialKey = getCfgKey(initialYear, initialMonthIndex);
        if (!localStorage.getItem(initialKey)) {
            saveMonthConfig(initialYear, initialMonthIndex, 2280); // NOV. 6: 2280 m³
        }

        const rd = document.getElementById("readingDate");
        rd.value = todayISO();
        const d = new Date(rd.value);
        updateMonthInfo(d);

        rd.addEventListener("change", function () {
            const dt = new Date(this.value);
            if (!isNaN(dt.getTime())) {
                updateMonthInfo(dt);
            }
        });
    }

    // Havi diktálás: kiválasztunk egy 6-ai dátumot, megadjuk az induló mérőállást
    function openMonthlyDict() {
        const suggestion = suggestNextSixth();
        const defStr = toISODateLocal(suggestion);

        const input = prompt(
            "Válassz egy 6-ai leolvasási dátumot (ÉÉÉÉ-HH-06):",
            defStr
        );
        if (input === null || input.trim() === "") return;

        const trimmed = input.trim();
        const dt = new Date(trimmed);
        if (isNaN(dt.getTime())) {
            alert("Érvénytelen dátum. Használd pl. ezt a formátumot: 2025-12-06");
            return;
        }
        if (dt.getDate() !== 6) {
            alert("A dátum napja legyen 6.");
            return;
        }

        const period = getGasPeriod(dt);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const gasLabel = formatGasPeriodLabel(period);

        let readingStr = document.getElementById("currentReading").value;
        let startVal;

        if (readingStr && readingStr.trim() !== "") {
            startVal = parseFloat(readingStr.replace(",", "."));
            if (isNaN(startVal)) {
                alert("Érvénytelen szám a mérőállás mezőben.");
                return;
            }
        } else {
            const ask = prompt(
                "Gáz-hónap: " + gasLabel + "\n" +
                "(" + period.startYear + ". " + monthNamesHu[period.startMonth] +
                ", keret: " + quota + " m³)\n\n" +
                "Írd be a leolvasott mérőállást (m³):"
            );
            if (ask === null || ask.trim() === "") return;
            startVal = parseFloat(ask.replace(",", "."));
            if (isNaN(startVal)) {
                alert("Érvénytelen szám.");
                return;
            }
        }

        saveMonthConfig(period.startYear, period.startMonth, startVal);
        addHistory({
            type: "monthly",
            date: toISODateLocal(dt),
            reading: startVal,
            periodStartYear: period.startYear,
            periodStartMonth: period.startMonth,
            quota: quota,
            gasLabel: gasLabel
        });

        // állítsuk át a dátumot is erre a 6-ára, hogy lásd
        document.getElementById("readingDate").value = toISODateLocal(dt);
        updateMonthInfo(dt);

        alert(
            "Havi induló állás rögzítve: " + startVal + " m³\n" +
            "Gáz-hónap: " + gasLabel
        );
    }

    function calculate() {
        const dateStr = document.getElementById("readingDate").value;
        const readingStr = document.getElementById("currentReading").value;
        const resultDiv = document.getElementById("calcResult");

        if (!dateStr || !readingStr) {
            alert("Add meg a dátumot és a mai mérőállást.");
            return;
        }

        const dt = new Date(dateStr);
        if (isNaN(dt.getTime())) {
            alert("Érvénytelen dátum.");
            return;
        }

        const period = getGasPeriod(dt);
        const quota = monthlyQuota[period.startMonth + 1] || 0;
        const daysInGasMonth = period.totalDays;
        const daysElapsed = period.daysElapsed;
        const gasLabel = formatGasPeriodLabel(period);

        let cfg = loadMonthConfig(period.startYear, period.startMonth);
        let startReading = cfg && cfg.startReading != null ? cfg.startReading : null;

        if (startReading == null || isNaN(startReading)) {
            const ask = prompt(
                "Nincs beállítva induló mérőállás ehhez a gáz-hónaphoz:\n" +
                gasLabel + "\n" +
                "(" + period.startYear + ". " +
                monthNamesHu[period.startMonth] + ", keret: " +
                quota + " m³)\n\nAdd meg most (m³):"
            );
            if (ask === null || ask.trim() === "") {
                resultDiv.textContent = "Nincs induló mérőállás, megszakítva.";
                return;
            }
            startReading = parseFloat(ask.replace(",", "."));
            if (isNaN(startReading)) {
                alert("Érvénytelen szám.");
                return;
            }
            saveMonthConfig(period.startYear, period.startMonth, startReading);
            cfg = loadMonthConfig(period.startYear, period.startMonth);
            updateMonthInfo(dt);
        }

        let currentReading = parseFloat(readingStr.replace(",", "."));
        if (isNaN(currentReading)) {
            alert("Érvénytelen szám a mai mérőállásnál.");
            return;
        }

        if (currentReading < startReading) {
            alert("A mai mérőállás nem lehet kisebb, mint a gáz-hónap induló mérőállása.");
            return;
        }

        const consumedSoFar = currentReading - startReading;
        const dailyQuota = quota / daysInGasMonth;
        const allowedSoFar = dailyQuota * daysElapsed;
        const remaining = quota - consumedSoFar;
        const daysLeft = daysInGasMonth - daysElapsed;

        const avgHoursFullMonth = dailyQuota / HOURLY_USAGE;
        let avgHoursRemaining = 0;
        if (daysLeft > 0 && remaining > 0) {
            avgHoursRemaining = (remaining / daysLeft) / HOURLY_USAGE;
        }

        const idealMeterToday = startReading + allowedSoFar;

        const consumedStr = consumedSoFar.toFixed(1).replace(".", ",");
        const quotaStr = quota.toString();
        const dailyStr = dailyQuota.toFixed(1).replace(".", ",");
        const allowedStr = allowedSoFar.toFixed(1).replace(".", ",");
        const idealMeterStr = Math.round(idealMeterToday).toString();
        const currentMeterStr = currentReading.toString();
        const remainingStr = remaining.toFixed(1).replace(".", ",");

        const avgHoursFullStr = avgHoursFullMonth.toFixed(2).replace(".", ",");
        const avgHoursRemStr = avgHoursRemaining.toFixed(2).replace(".", ",");

        let diff = consumedSoFar - allowedSoFar;
        let diffText, diffClass;
        if (Math.abs(diff) < 0.1) {
            diffText = "Körülbelül pont a tervezett napi átlagos pályán vagy.";
            diffClass = "neutral";
        } else if (diff > 0) {
            diffText = "A gáz-hónap átlagához képest kb. +" +
                diff.toFixed(1).replace(".", ",") + " m³-rel többet fogyasztottál.";
            diffClass = "bad";
        } else {
            diffText = "A gáz-hónap átlagához képest kb. " +
                diff.toFixed(1).replace(".", ",") + " m³ tartalékod van.";
            diffClass = "good";
        }

        let remainingText;
        if (remaining > 0) {
            remainingText = "A kedvezményes keretből még kb. " +
                remainingStr + " m³ maradt ebben a gáz-hónapban.";
        } else {
            const over = Math.abs(remaining).toFixed(1).replace(".", ",");
            remainingText = "A kedvezményes keretet már kb. " +
                over + " m³-rel túllépted ebben a gáz-hónapban.";
        }

        let hoursText = "";
        hoursText += "Elméleti átlagos üzemidő a teljes gáz-hónapra: kb. " +
            avgHoursFullStr + " óra/nap (a " + dailyStr +
            " m³/nap keret és " + HOURLY_USAGE +
            " m³/óra fogyasztás mellett).";

        if (daysLeft > 0 && remaining > 0) {
            hoursText += "<br>Innentől a gáz-hónap végéig átlagosan kb. " +
                avgHoursRemStr + " óra/nap fér bele, ha a kereten belül akarsz maradni.";
        }

        const gasLabel2 = formatGasPeriodLabel(period);

        resultDiv.innerHTML =
            "<div class='mono'>Dátum: " + dateStr +
            " · Gáz-hónap: " + gasLabel2 +
            " · Keret: " + quotaStr + " m³</div>" +
            "<div style='margin-top:4px;'>Induló mérőállás (gáz-hónap elején): <span class='mono'>" +
            startReading + " m³</span></div>" +
            "<div>Mai mérőállás: <span class='mono'>" + currentMeterStr + " m³</span></div>" +
            "<div style='margin-top:4px;'>Eddigi fogyasztás ebben a gáz-hónapban: <b>" +
            consumedStr + " m³</b></div>" +
            "<div>Napi átlagos megengedett fogyasztás: <b>" + dailyStr + " m³/nap</b></div>" +
            "<div>Eddig megengedett fogyasztás (a gáz-hónap " + daysElapsed +
            ". napjáig): <b>" + allowedStr + " m³</b></div>" +
            "<div style='margin-top:4px;'>Ideális mai óraállás: <span class='mono'><b>" +
            idealMeterStr + " m³</b></span></div>" +
            "<div>Mostani óraállás: <span class='mono'><b>" +
            currentMeterStr + " m³</b></span></div>" +
            "<div style='margin-top:4px;' class='" + diffClass + "'>" + diffText + "</div>" +
            "<div class='neutral' style='margin-top:4px;'>" + remainingText + "</div>" +
            "<div class='small' style='margin-top:4px;'>" + hoursText + "</div>";

        // napi előzmény mentése
        addHistory({
            type: "daily",
            date: dateStr,
            reading: currentReading,
            periodStartYear: period.startYear,
            periodStartMonth: period.startMonth,
            quota: quota,
            gasLabel: gasLabel2,
            consumed: consumedSoFar,
            remaining: remaining,
            daysElapsed: daysElapsed,
            daysTotal: daysInGasMonth,
            idealMeter: idealMeterToday,
            diff: diff,
            avgHoursFullMonth: avgHoursFullMonth,
            avgHoursRemaining: avgHoursRemaining
        });
    }

    function showHistory() {
        const hist = getHistory();
        if (!hist.length) {
            alert("Nincs elmentett előzmény.");
            return;
        }

        hist.sort((a, b) => (b.ts || "").localeCompare(a.ts || ""));

        const lines = hist.map(entry => {
            if (entry.type === "monthly") {
                const d = entry.date || "";
                const r = entry.reading != null ? entry.reading : "?";
                const label = entry.gasLabel || "";
                return "[Havi]  " + d +
                    " · induló: " + r + " m³ · " + label;
            } else if (entry.type === "daily") {
                const d = entry.date || "";
                const r = entry.reading != null ? entry.reading : "?";
                const c = (typeof entry.consumed === "number")
                    ? entry.consumed.toFixed(1).replace(".", ",")
                    : "?";
                const rem = (typeof entry.remaining === "number")
                    ? entry.remaining.toFixed(1).replace(".", ",")
                    : "?";
                const hrs = (typeof entry.avgHoursRemaining === "number")
                    ? entry.avgHoursRemaining.toFixed(2).replace(".", ",")
                    : "?";
                const label = entry.gasLabel || "";
                return "[Napi] " + d +
                    " · mérő: " + r + " m³ · fogy: " + c +
                    " m³ · marad: " + rem + " m³ · órák/nap innentől: " +
                    hrs + " · " + label;
            } else {
                return "[Ismeretlen] " + JSON.stringify(entry);
            }
        });

        alert(lines.join("\n"));
    }

    // induláskor
    init();
</script>
</body>
</html>
